<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Disc.Analyzer.ViewModels"
             xmlns:models="using:Disc.Analyzer.Models"
             xmlns:fi="using:FluentIcons.Avalonia"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Disc.Analyzer.Views.FolderTreeView"
             x:DataType="vm:MainWindowViewModel">

    <Grid RowDefinitions="Auto,*">
        <!-- Directory Structure Header -->
        <Grid Margin="14,8,14,8" ColumnDefinitions="*,Auto">
            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <fi:SymbolIcon Symbol="Folder" FontSize="16" Foreground="#3B82F6"/>
                <TextBlock Text="{Binding RootNode.FullPath, FallbackValue='Select a drive or folder'}" 
                           FontSize="12" Opacity="0.7"
                           TextTrimming="CharacterEllipsis"
                           VerticalAlignment="Center"/>
            </StackPanel>
            
            <!-- Expansion Level Controls -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" VerticalAlignment="Top">
                <Button Command="{Binding CollapseAllCommand}"
                        ToolTip.Tip="Collapse all"
                        Background="Transparent"
                        Padding="6">
                    <fi:SymbolIcon Symbol="ChevronDoubleUp" FontSize="14"/>
                </Button>
                <Button Command="{Binding CollapseLevelCommand}"
                        ToolTip.Tip="Collapse one level"
                        Background="Transparent"
                        Padding="6">
                    <fi:SymbolIcon Symbol="ChevronUp" FontSize="14"/>
                </Button>
                <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="8,4"
                        VerticalAlignment="Center">
                    <TextBlock Text="{Binding ExpansionLevelText}" 
                               FontSize="11" 
                               MinWidth="50"
                               TextAlignment="Center"/>
                </Border>
                <Button Command="{Binding ExpandLevelCommand}"
                        ToolTip.Tip="Expand one level"
                        Background="Transparent"
                        Padding="6">
                    <fi:SymbolIcon Symbol="ChevronDown" FontSize="14"/>
                </Button>
                <Button Command="{Binding ExpandAllCommand}"
                        ToolTip.Tip="Expand all"
                        Background="Transparent"
                        Padding="6">
                    <fi:SymbolIcon Symbol="ChevronDoubleDown" FontSize="14"/>
                </Button>
            </StackPanel>
        </Grid>
        
        <!-- Tree View with Virtualization -->
        <TreeView Grid.Row="1"
                  ItemsSource="{Binding TreeItems}"
                  SelectedItem="{Binding SelectedNode}"
                  Padding="14,0,26,0"
                  ScrollViewer.HorizontalScrollBarVisibility="Auto">
            <TreeView.Styles>
                <Style Selector="TreeViewItem" x:DataType="models:FileSystemNode">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                </Style>
                <!-- Highlight search results with yellow background -->
                <Style Selector="TreeViewItem" x:DataType="models:FileSystemNode">
                    <Style.Animations/>
                </Style>
            </TreeView.Styles>
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}" x:DataType="models:FileSystemNode">
                    <Border CornerRadius="4" 
                            Padding="0"
                            Background="{Binding IsHighlighted, Converter={x:Static vm:Converters.HighlightToBackground}}">
                        <Grid ColumnDefinitions="Auto,*,150,60,90,95" MinHeight="28" Margin="0,1">
                            <!-- Folder/File Icon -->
                            <Panel Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Center">
                                <fi:SymbolIcon Symbol="Folder" FontSize="16" Foreground="#3B82F6"
                                               IsVisible="{Binding IsDirectory}"/>
                                <fi:SymbolIcon Symbol="Document" FontSize="16" Foreground="#6B7280"
                                           IsVisible="{Binding !IsDirectory}"/>
                        </Panel>
                        
                        <!-- Name -->
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding Name}" 
                                   VerticalAlignment="Center"
                                   MaxWidth="400"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTip.Tip="{Binding Name}"/>
                        
                        <!-- Size percentage bar -->
                        <Grid Grid.Column="2" VerticalAlignment="Center" Margin="0,8">
                            <Border Height="4" CornerRadius="2" 
                                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"/>
                            <Border Height="4" CornerRadius="2" 
                                    Background="#3B82F6"
                                    HorizontalAlignment="Left"
                                    Width="{Binding SizePercentage, Converter={x:Static vm:Converters.PercentageToWidth}}"/>
                        </Grid>
                        
                        <!-- Percentage text -->
                        <TextBlock Grid.Column="3"
                                   Text="{Binding SizePercentage, StringFormat={}{0:F0}%}"
                                   FontSize="11"
                                   Foreground="#888888"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Center"/>
                        
                        <!-- Size -->
                        <TextBlock Grid.Column="4" 
                                   Text="{Binding FormattedSize}" 
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Center"
                                   FontFamily="Consolas, Menlo, monospace"/>
                        
                        <!-- File Count -->
                        <TextBlock Grid.Column="5" 
                                   Text="{Binding FileCountText}"
                                   FontSize="11"
                                   Opacity="0.6"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Center"
                                   Margin="8,0,4,0"/>
                    </Grid>
                    </Border>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>
    </Grid>
</UserControl>
